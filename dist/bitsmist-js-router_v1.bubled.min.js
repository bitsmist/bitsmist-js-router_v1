!function(){"use strict";function e(e,r){void 0===r&&(r={});for(var n=function(e){for(var t=[],r=0;r<e.length;){var n=e[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)t.push({type:"CHAR",index:r,value:e[r++]});else{var i=1,o="";if("?"===e[u=r+1])throw new TypeError('Pattern cannot start with "?" at '+u);for(;u<e.length;)if("\\"!==e[u]){if(")"===e[u]){if(0==--i){u++;break}}else if("("===e[u]&&(i++,"?"!==e[u+1]))throw new TypeError("Capturing groups are not allowed at "+u);o+=e[u++]}else o+=e[u++]+e[u++];if(i)throw new TypeError("Unbalanced pattern at "+r);if(!o)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:o}),r=u}else{for(var a="",u=r+1;u<e.length;){var s=e.charCodeAt(u);if(!(s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||95===s))break;a+=e[u++]}if(!a)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:a}),r=u}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),i=r.prefixes,o=void 0===i?"./":i,a="[^"+t(r.delimiter||"/#?")+"]+?",u=[],s=0,f=0,c="",p=function(e){if(f<n.length&&n[f].type===e)return n[f++].value},l=function(e){var t=p(e);if(void 0!==t)return t;var r=n[f],i=r.type,o=r.index;throw new TypeError("Unexpected "+i+" at "+o+", expected "+e)},d=function(){for(var e,t="";e=p("CHAR")||p("ESCAPED_CHAR");)t+=e;return t};f<n.length;){var h=p("CHAR"),_=p("NAME"),v=p("PATTERN");if(_||v){var g=h||"";-1===o.indexOf(g)&&(c+=g,g=""),c&&(u.push(c),c=""),u.push({name:_||s++,prefix:g,suffix:"",pattern:v||a,modifier:p("MODIFIER")||""})}else{var m=h||p("ESCAPED_CHAR");if(m)c+=m;else if(c&&(u.push(c),c=""),p("OPEN")){g=d();var S=p("NAME")||"",R=p("PATTERN")||"",I=d();l("CLOSE"),u.push({name:S||(R?s++:""),pattern:S&&!R?a:R,prefix:g,suffix:I,modifier:p("MODIFIER")||""})}else l("END")}}return u}function t(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function r(e){return e&&e.sensitive?"":"i"}function n(n,i,o){return function(e,n,i){void 0===i&&(i={});for(var o=i.strict,a=void 0!==o&&o,u=i.start,s=void 0===u||u,f=i.end,c=void 0===f||f,p=i.encode,l=void 0===p?function(e){return e}:p,d="["+t(i.endsWith||"")+"]|$",h="["+t(i.delimiter||"/#?")+"]",_=s?"^":"",v=0,g=e;v<g.length;v++){var m=g[v];if("string"==typeof m)_+=t(l(m));else{var S=t(l(m.prefix)),R=t(l(m.suffix));if(m.pattern)if(n&&n.push(m),S||R)if("+"===m.modifier||"*"===m.modifier){var I="*"===m.modifier?"?":"";_+="(?:"+S+"((?:"+m.pattern+")(?:"+R+S+"(?:"+m.pattern+"))*)"+R+")"+I}else _+="(?:"+S+"("+m.pattern+")"+R+")"+m.modifier;else _+="("+m.pattern+")"+m.modifier;else _+="(?:"+S+R+")"+m.modifier}}if(c)a||(_+=h+"?"),_+=i.endsWith?"(?="+d+")":"$";else{var y=e[e.length-1],w="string"==typeof y?h.indexOf(y[y.length-1])>-1:void 0===y;a||(_+="(?:"+h+"(?="+d+"))?"),w||(_+="(?="+h+"|"+d+")")}return new RegExp(_,r(i))}(e(n,o),i,o)}function i(e,t,o){return e instanceof RegExp?function(e,t){if(!t)return e;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,n=0,i=r.exec(e.source);i;)t.push({name:i[1]||n++,prefix:"",suffix:"",modifier:"",pattern:""}),i=r.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,n){var o=e.map((function(e){return i(e,t,n).source}));return new RegExp("(?:"+o.join("|")+")",r(n))}(e,t,o):n(e,t,o)}var o=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.init=function(e,r){Object.defineProperty(e,"routeInfo",{get:function(){return this._routeInfo}}),Object.defineProperty(e,"specs",{get:function(){return this._specs}}),Object.defineProperty(e,"spec",{get:function(){return this._spec}}),e.loadParameters=function(e){return t._loadParameters(e)},e.switchSpec=function(e){return t._switchSpec(this,e)},e.openRoute=function(e,r){return t._open(this,e,r)},e.jumpRoute=function(e,r){return t._jumpRoute(this,e,r)},e.updateRoute=function(e,r){return t._updateRoute(this,e,r)},e.refreshRoute=function(e,r){return t._refreshRoute(this,e,r)},e.replaceRoute=function(e,r){return t._replaceRoute(this,e,r)},e.validateRoute=function(){return t._validateRoute(this)},e.normalizeRoute=function(){return t._normalizeRoute(this)},e._routes=[],e._specs={},e._spec=new BITSMIST.v1.ChainableStore({chain:e.settings,writeThrough:!0}),Object.defineProperty(e,"settings",{get:function(){return this._spec}}),t.__initPopState(e),history.replaceState(t.__getState("connect"),null,null)},t.organize=function(e,r,n){t.__loadAttrSettings(r);var i=n.routes;if(i)for(var o=0;o<i.length;o++)t._addRoute(r,i[o]);r._routeInfo=t.__loadRouteInfo(r,window.location.href);var a=r.settings.get("specs");a&&Object.keys(a).forEach((function(e){r._specs[e]=a[e]}))},t._addRoute=function(e,t,r){var n=[],o={origin:t.origin,name:t.name,path:t.path,keys:n,specName:t.specName,componentName:t.componentName,re:i(t.path,n)};r?e._routes.unshift(o):e._routes.push(o)},t._buildUrl=function(e,r,n){var i="";if(i+=r.url?r.url:"",i+=r.path?r.path:"",i+=r.query?"?"+r.query:"",r.queryParameters){var o={};n&&n.mergeParameters&&(o=Object.assign(o,e.routeInfo.queryParameters)),o=Object.assign(o,r.queryParameters),i+=t._buildUrlQuery(o)}return i||"/"},t._buildUrlQuery=function(e){var t="";return e&&(t=Object.keys(e).reduce((function(t,r){return Array.isArray(e[r])?t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r].join())+"&":e[r]&&(t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r])+"&"),t}),"")),t?"?"+t.slice(0,-1):""},t._loadParameters=function(e){e=e||window.location.href;var t,r,n={};if(window.location.href.indexOf("?")>-1)for(var i=e.slice(e.indexOf("?")+1).split("&"),o=0;o<i.length;o++)r=(t=i[o].split("="))[1]?t[1].split("#")[0]:t[1],n[t[0]]=decodeURIComponent(r);return n},t._switchSpec=function(e,r){return BITSMIST.v1.Util.assert(r,"RouteOrganizer._switchSpec(): A spec name not specified.",TypeError),Promise.resolve().then((function(){if(!e._specs[r])return t.__loadSpec(e,r,e.settings.get("system.specPath")).then((function(t){e._specs[r]=t}))})).then((function(){e._spec.items=e._specs[r]})).then((function(){return e.addOrganizers(e._specs[r])})).then((function(){return e.callOrganizers("afterSpecLoad",e._specs[r])})).then((function(){return e.trigger("afterSpecLoad",{spec:e._specs[e._routeInfo.specName]})}))},t._open=function(e,r,n){n=Object.assign({},n);var i,o,a=BITSMIST.v1.Util.safeGet(n,"pushState",!!r),u=e._routeInfo;if(r?(i=t._buildUrl(e,r,n),o=t.__loadRouteInfo(e,i)):(i=window.location.href,o=u),!n.jump&&o.name&&u.specName==o.specName)return Promise.resolve().then((function(){a&&history.pushState(t.__getState("_open.pushState"),null,i),e._routeInfo=o})).then((function(){if(u.specName!=o.specName)return t._updateRoute(e,u,o,n)})).then((function(){return t._validateRoute(e,i)})).then((function(){return t._refreshRoute(e,o,n)})).then((function(){return t._normalizeRoute(e,window.location.href)}));t._jumpRoute(e,{url:i})},t._jumpRoute=function(e,r,n){var i=t._buildUrl(e,r,n);window.location.href=i},t._updateRoute=function(e,r,n,i){return Promise.resolve().then((function(){return e.changeState("routing")})).then((function(){return e.clearOrganizers("afterStart",e._specs[r.specName])})).then((function(){return e.clearOrganizers("afterSpecLoad",e._specs[r.specName])})).then((function(){return t._switchSpec(e,n.specName)})).then((function(){return e._postStart()}))},t._refreshRoute=function(e,t,r){return e.refresh(r)},t._replaceRoute=function(e,r,n){history.replaceState(t.__getState("replaceRoute",window.history.state),null,t._buildUrl(e,r,n)),e._routeInfo=t.__loadRouteInfo(e,window.location.href)},t._validateRoute=function(e,r){return e.validationResult.result=!0,Promise.resolve().then((function(){return e.trigger("beforeValidate")})).then((function(){return e.callOrganizers("doCheckValidity",{item:t._loadParameters(r),validationName:e.settings.get("settings.validationName")})})).then((function(){if(!e.validationResult.result&&e.settings.get("settings.autoFixURL"))return t.__fixRoute(e,r)})).then((function(){return e.trigger("doValidate")})).then((function(){return e.trigger("afterValidate")})).then((function(){if(!e.validationResult.result)throw t.__dumpValidationErrors(e),new URIError("URL validation failed.")}))},t._normalizeRoute=function(e,t){return Promise.resolve().then((function(){return e.trigger("beforeNormalizeURL")})).then((function(){return e.trigger("doNormalizeURL")})).then((function(){return e.trigger("afterNormalizeURL")}))},t.__loadAttrSettings=function(e){var t=e.getAttribute("bm-specpath");t&&e.settings.set("system.specPath",t)},t.__loadSpec=function(e,t,r){var n=[],i={type:"js",bindTo:this};return n.push(e.loadSettingFile(t,r,i)),Promise.all(n).then((function(e){return e[0]}))},t.__loadRouteInfo=function(e,r){for(var n,i,o={},a=new URL(r,window.location.href),u={},s=e._routes.length-1;s>=0;s--)if(!e._routes[s].origin||a.origin==e._routes[s].origin){var f=e._routes[s].path?e._routes[s].re.exec(a.pathname):[];if(f){n=e._routes[s].name,i=e._routes[s].specName?e._routes[s].specName:"";for(var c=0;c<f.length-1;c++){u[e._routes[s].keys[c].name]=f[c+1];var p=e._routes[s].keys[c].name,l=f[c+1];i=i.replace("{{:"+p+"}}",l)}break}}return o.name=n,o.specName=i,o.url=a.href,o.path=a.pathname,o.query=a.search,o.parsedUrl=a,o.routeParameters=u,o.queryParameters=t._loadParameters(r),o},t.__initPopState=function(e){window.addEventListener("popstate",(function(r){return Promise.resolve().then((function(){return e.trigger("beforePopState")})).then((function(){return t._open(e,{url:window.location.href},{pushState:!1})})).then((function(){return e.trigger("afterPopState")}))}))},t.__getState=function(e,t){var r={msg:e};return t&&(r=BITSMIST.v1.Util.deepMerge(BITSMIST.v1.Util.deepClone(t),r)),r},t.__fixRoute=function(e,r){var n=!0,i=t._loadParameters(r);Object.keys(e.validationResult.invalids).forEach((function(t){var r=e.validationResult.invalids[t];void 0!==r.fix?i[r.key]=r.fix:"notAllowed"===r.failed[0].validity?delete i[r.key]:n=!1})),n&&(t._replaceRoute(e,{queryParameters:i}),e.validationResult.result=!0)},t.__dumpValidationErrors=function(e){Object.keys(e.validationResult.invalids).forEach((function(t){var r=e.validationResult.invalids[t];if(r.failed)for(var n=0;n<r.failed.length;n++);}))},t}(BITSMIST.v1.Organizer);function a(){return Reflect.construct(BITSMIST.v1.Component,[],this.constructor)}BITSMIST.v1.ClassUtil.inherit(a,BITSMIST.v1.Component),customElements.define("bm-router",a),a.prototype._getSettings=function(e){var t={settings:{name:"Router",autoFixURL:!1,autoFetch:!1,autoSetup:!1,autoRefresh:!1,hasTemplate:!1,rootElement:document.body},organizers:{RouteOrganizer:{settings:{attach:!0}},ValidationOrganizer:{settings:{attach:!0}}},events:{this:{handlers:{doStart:["onDoStart"],afterStart:["onAfterStart"]}}}};return e=e?BITSMIST.v1.Util.deepMerge(e,t):t},a.prototype.onDoStart=function(e,t,r){var n=this;if(this.routeInfo.specName)return this.switchSpec(this.routeInfo.specName).then((function(){if(n.settings.get("settings.hasExtender")){var e=n.routeInfo.specName+".extender.js",t=BITSMIST.v1.Util.concatPath([BITSMIST.v1.settings.get("system.appBaseUrl",""),BITSMIST.v1.settings.get("system.specPath","")]);return BITSMIST.v1.AjaxUtil.loadScript(t+e)}}))},a.prototype.onAfterStart=function(e,t,r){return this.openRoute()},window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},BITSMIST.v1.OrganizerOrganizer.register("RouteOrganizer",{object:o,targetWords:"routes",targetEvents:["beforeStart","afterSpecLoad"],order:900}),window.BITSMIST.v1.Router=a}();
