!function(){"use strict";function e(e,n){void 0===n&&(n={});for(var r=function(e){for(var t=[],n=0;n<e.length;){var r=e[n];if("*"!==r&&"+"!==r&&"?"!==r)if("\\"!==r)if("{"!==r)if("}"!==r)if(":"!==r)if("("!==r)t.push({type:"CHAR",index:n,value:e[n++]});else{var o=1,i="";if("?"===e[s=n+1])throw new TypeError('Pattern cannot start with "?" at '+s);for(;s<e.length;)if("\\"!==e[s]){if(")"===e[s]){if(0==--o){s++;break}}else if("("===e[s]&&(o++,"?"!==e[s+1]))throw new TypeError("Capturing groups are not allowed at "+s);i+=e[s++]}else i+=e[s++]+e[s++];if(o)throw new TypeError("Unbalanced pattern at "+n);if(!i)throw new TypeError("Missing pattern at "+n);t.push({type:"PATTERN",index:n,value:i}),n=s}else{for(var a="",s=n+1;s<e.length;){var u=e.charCodeAt(s);if(!(u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||95===u))break;a+=e[s++]}if(!a)throw new TypeError("Missing parameter name at "+n);t.push({type:"NAME",index:n,value:a}),n=s}else t.push({type:"CLOSE",index:n,value:e[n++]});else t.push({type:"OPEN",index:n,value:e[n++]});else t.push({type:"ESCAPED_CHAR",index:n++,value:e[n++]});else t.push({type:"MODIFIER",index:n,value:e[n++]})}return t.push({type:"END",index:n,value:""}),t}(e),o=n.prefixes,i=void 0===o?"./":o,a="[^"+t(n.delimiter||"/#?")+"]+?",s=[],u=0,p=0,f="",c=function(e){if(p<r.length&&r[p].type===e)return r[p++].value},l=function(e){var t=c(e);if(void 0!==t)return t;var n=r[p],o=n.type,i=n.index;throw new TypeError("Unexpected "+o+" at "+i+", expected "+e)},d=function(){for(var e,t="";e=c("CHAR")||c("ESCAPED_CHAR");)t+=e;return t};p<r.length;){var _=c("CHAR"),h=c("NAME"),m=c("PATTERN");if(h||m){var g=_||"";-1===i.indexOf(g)&&(f+=g,g=""),f&&(s.push(f),f=""),s.push({name:h||u++,prefix:g,suffix:"",pattern:m||a,modifier:c("MODIFIER")||""})}else{var v=_||c("ESCAPED_CHAR");if(v)f+=v;else if(f&&(s.push(f),f=""),c("OPEN")){g=d();var S=c("NAME")||"",w=c("PATTERN")||"",I=d();l("CLOSE"),s.push({name:S||(w?u++:""),pattern:S&&!w?a:w,prefix:g,suffix:I,modifier:c("MODIFIER")||""})}else l("END")}}return s}function t(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function n(e){return e&&e.sensitive?"":"i"}function r(r,o,i){return function(e,r,o){void 0===o&&(o={});for(var i=o.strict,a=void 0!==i&&i,s=o.start,u=void 0===s||s,p=o.end,f=void 0===p||p,c=o.encode,l=void 0===c?function(e){return e}:c,d="["+t(o.endsWith||"")+"]|$",_="["+t(o.delimiter||"/#?")+"]",h=u?"^":"",m=0,g=e;m<g.length;m++){var v=g[m];if("string"==typeof v)h+=t(l(v));else{var S=t(l(v.prefix)),w=t(l(v.suffix));if(v.pattern)if(r&&r.push(v),S||w)if("+"===v.modifier||"*"===v.modifier){var I="*"===v.modifier?"?":"";h+="(?:"+S+"((?:"+v.pattern+")(?:"+w+S+"(?:"+v.pattern+"))*)"+w+")"+I}else h+="(?:"+S+"("+v.pattern+")"+w+")"+v.modifier;else h+="("+v.pattern+")"+v.modifier;else h+="(?:"+S+w+")"+v.modifier}}if(f)a||(h+=_+"?"),h+=o.endsWith?"(?="+d+")":"$";else{var y=e[e.length-1],T="string"==typeof y?_.indexOf(y[y.length-1])>-1:void 0===y;a||(h+="(?:"+_+"(?="+d+"))?"),T||(h+="(?="+_+"|"+d+")")}return new RegExp(h,n(o))}(e(r,i),o,i)}function o(e,t,i){return e instanceof RegExp?function(e,t){if(!t)return e;for(var n=/\((?:\?<(.*?)>)?(?!\?)/g,r=0,o=n.exec(e.source);o;)t.push({name:o[1]||r++,prefix:"",suffix:"",modifier:"",pattern:""}),o=n.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,r){var i=e.map((function(e){return o(e,t,r).source}));return new RegExp("(?:"+i.join("|")+")",n(r))}(e,t,i):r(e,t,i)}var i=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.globalInit=function(){t.__skipPopstate=!1;var e=window.navigator.userAgent.toLowerCase();e.indexOf("safari")>-1&&-1==e.indexOf("chrome")&&window.addEventListener("DOMContentLoaded",(function(e){t.__skipPopstate=!0}))},t.init=function(e,n,r){Object.defineProperty(n,"routeInfo",{get:function(){return this._routeInfo}}),Object.defineProperty(n,"specs",{get:function(){return this._specs}}),n.loadParameters=function(){return t._loadParameters()},n.openRoute=function(e,n){return t._open(this,e,n)},n.replaceRoute=function(e,n){return t._replace(this,e,n)},n.jumpRoute=function(e,n){return t._jump(this,e,n)},n.refreshRoute=function(e,n){return t._refresh(this,e,n)},n.updateRoute=function(e,n){return t._update(this,e,n)},n._routes=[],n._specs={},t.__initPopState(n),history.replaceState(t.__getState("connect"),null,null)},t.organize=function(e,n,r){var o=n.settings.get("routes");if(o){for(var i=0;i<o.length;i++)t._addRoute(n,o[i]);n._routeInfo=t.__loadRouteInfo(n,window.location.href)}var a=n.settings.get("specs");return a&&Object.keys(a).forEach((function(e){n._specs[e]=a[e]})),r},t._addRoute=function(e,t,n){var r=[],i={origin:t.origin,name:t.name,path:t.path,keys:r,specName:t.specName,componentName:t.componentName,re:o(t.path,r)};n?e._routes.unshift(i):e._routes.push(i)},t._buildUrl=function(e,n){var r;return e.url?r=e.url:(r=e.path?e.path:n._routeInfo.path,r+=e.query?"?"+e.query:"",r+=e.queryParameters?t._buildUrlQuery(e.queryParameters):""),r},t._buildUrlQuery=function(e){var t="";return e&&(t=Object.keys(e).reduce((function(t,n){return Array.isArray(e[n])?t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n].join())+"&":e[n]&&(t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n])+"&"),t}),"")),t?"?"+t.slice(0,-1):""},t._loadParameters=function(){var e,t,n={};if(window.location.href.indexOf("?")>-1)for(var r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<r.length;o++)t=(e=r[o].split("="))[1]?e[1].split("#")[0]:e[1],n[e[0]]=decodeURIComponent(t);return n},t._open=function(e,n,r){(r=Object.assign({},r)).pushState=void 0===r.pushState||r.pushState;var o=t._buildUrl(n,e),i=Object.assign({},e._routeInfo),a=t.__loadRouteInfo(e,o);if(e._routeInfo=a,!r.jump&&a.name&&i.name==a.name)return Promise.resolve().then((function(){r.pushState&&history.pushState(t.__getState("_open.pushState"),null,o)})).then((function(){return i.specName!=a.specName?t._update(e,a,r):t._refresh(e,n,r)})).then((function(){n.dispUrl&&history.replaceState(t.__getState("_open.dispUrl",window.history.state),null,n.dispUrl)}));t._jump(e,{url:o})},t._jump=function(e,n){var r=t._buildUrl(n,e);window.location.href=r},t._refresh=function(e,t,n){var r=e._routeInfo.componentName;if(e._components&&e._components[r])return e._components[r].refresh({sender:e,pushState:!1})},t._update=function(e,n,r){return Promise.resolve().then((function(){return e.clearOrganizers()})).then((function(){return t.__initSpec(e,n.specName)}))},t._replace=function(e,n,r){history.replaceState(t.__getState("replaceRoute",window.history.state),null,t._buildUrl(n,e)),e._routeInfo=t.__loadRouteInfo(e,window.location.href)},t.__initSpec=function(e,n){if(n&&!e._specs[n])return Promise.resolve().then((function(){if(!e._specs[n])return t.__loadSpec(n,e.settings.get("system.specPath")).then((function(t){e._specs[n]=t}))})).then((function(){return e.callOrganizers("afterSpecLoad",e._specs[n])})).then((function(){return e.trigger("afterSpecLoad",e,{spec:e._specs[e._routeInfo.specName]})}))},t.__loadSpec=function(e,t){var n,r=BITSMIST.v1.Util.concatPath([t,e+".js"]),o=[];return o.push(BITSMIST.v1.AjaxUtil.ajaxRequest({url:r,method:"GET"})),Promise.all(o).then((function(e){try{n=JSON.parse(e[0].responseText)}catch(e){throw e instanceof SyntaxError?new SyntaxError("Illegal json string. url="+r+", message="+e.message):e}return n}))},t.__loadRouteInfo=function(e,n){for(var r,o,i,a={},s=new URL(n,window.location.href),u={},p=e._routes.length-1;p>=0;p--)if(!e._routes[p].origin||e._routes[p].origin&&s.origin==e._routes[p].origin){var f=e._routes[p].path?e._routes[p].re.exec(s.pathname):[];if(f){r=e._routes[p].name,o=e._routes[p].specName?e._routes[p].specName:"",i=e._routes[p].componentName;for(var c=0;c<f.length-1;c++){u[e._routes[p].keys[c].name]=f[c+1];var l=e._routes[p].keys[c].name,d=f[c+1];o=o.replace("{{:"+l+"}}",d)}break}}return a.name=r,a.specName=o,a.componentName=i,a.url=s.href,a.path=s.pathname,a.query=s.search,a.parsedUrl=s,a.routeParameters=u,a.queryParameters=t._loadParameters(),a},t.__initPopState=function(e){window.history&&window.history.pushState&&window.addEventListener("popstate",(function(n){if(!t.__skipPopstate){var r,o=e._routeInfo.componentName;return e._components&&e._components[o]&&(r=e._components[o].trigger("beforePopState",e)),Promise.all([r]).then((function(){return t._open(e,t.__loadRouteInfo(e,window.location.href),{pushState:!1})})).then((function(){var t=e._routeInfo.componentName;if(e._components&&e._components[t])return e._components[t].trigger("afterPopState",e)}))}t.__skipPopstate=!1}))},t.__getState=function(e,t){var n={msg:e};return t&&(n=Object.assign({},t,n)),n},t}(BITSMIST.v1.Organizer);function a(){return Reflect.construct(BITSMIST.v1.Component,[],this.constructor)}BITSMIST.v1.ClassUtil.inherit(a,BITSMIST.v1.Component),customElements.define("bm-router",a),a.prototype.start=function(e){var t=this;return e=BITSMIST.v1.Util.deepMerge({settings:{name:"Router",autoSetup:!1,rootElement:"body"},organizers:{RouteOrganizer:""}},e),BITSMIST.v1.Component.prototype.start.call(this,e).then((function(){t.changeState("routing");var e=t.getAttribute("data-specpath")||"";return e&&t._settings.set("system.specPath",e),i.__initSpec(t,t._routeInfo.specName).then((function(){t.changeState("routed")}))}))},window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},BITSMIST.v1.OrganizerOrganizer.organizers.set("RouteOrganizer",{object:i,targetWords:"routes",targetEvents:["beforeStart","afterSpecLoad"],order:300}),BITSMIST.v1.OrganizerOrganizer.organizers.get("ComponentOrganizer").targetEvents.push("afterSpecLoad"),window.BITSMIST.v1.Router=a}();
