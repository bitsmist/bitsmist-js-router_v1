!function(){"use strict";function e(e,r){void 0===r&&(r={});for(var i=function(e){for(var t=[],r=0;r<e.length;){var i=e[r];if("*"!==i&&"+"!==i&&"?"!==i)if("\\"!==i)if("{"!==i)if("}"!==i)if(":"!==i)if("("!==i)t.push({type:"CHAR",index:r,value:e[r++]});else{var n=1,a="";if("?"===e[s=r+1])throw new TypeError('Pattern cannot start with "?" at '+s);for(;s<e.length;)if("\\"!==e[s]){if(")"===e[s]){if(0==--n){s++;break}}else if("("===e[s]&&(n++,"?"!==e[s+1]))throw new TypeError("Capturing groups are not allowed at "+s);a+=e[s++]}else a+=e[s++]+e[s++];if(n)throw new TypeError("Unbalanced pattern at "+r);if(!a)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:a}),r=s}else{for(var o="",s=r+1;s<e.length;){var u=e.charCodeAt(s);if(!(u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||95===u))break;o+=e[s++]}if(!o)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:o}),r=s}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),n=r.prefixes,a=void 0===n?"./":n,o="[^"+t(r.delimiter||"/#?")+"]+?",s=[],u=0,l=0,p="",c=function(e){if(l<i.length&&i[l].type===e)return i[l++].value},f=function(e){var t=c(e);if(void 0!==t)return t;var r=i[l],n=r.type,a=r.index;throw new TypeError("Unexpected "+n+" at "+a+", expected "+e)},d=function(){for(var e,t="";e=c("CHAR")||c("ESCAPED_CHAR");)t+=e;return t};l<i.length;){var h=c("CHAR"),g=c("NAME"),_=c("PATTERN");if(g||_){var m=h||"";-1===a.indexOf(m)&&(p+=m,m=""),p&&(s.push(p),p=""),s.push({name:g||u++,prefix:m,suffix:"",pattern:_||o,modifier:c("MODIFIER")||""})}else{var S=h||c("ESCAPED_CHAR");if(S)p+=S;else if(p&&(s.push(p),p=""),c("OPEN")){m=d();var v=c("NAME")||"",I=c("PATTERN")||"",R=d();f("CLOSE"),s.push({name:v||(I?u++:""),pattern:v&&!I?o:I,prefix:m,suffix:R,modifier:c("MODIFIER")||""})}else f("END")}}return s}function t(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function r(e){return e&&e.sensitive?"":"i"}function i(i,n,a){return function(e,i,n){void 0===n&&(n={});for(var a=n.strict,o=void 0!==a&&a,s=n.start,u=void 0===s||s,l=n.end,p=void 0===l||l,c=n.encode,f=void 0===c?function(e){return e}:c,d="["+t(n.endsWith||"")+"]|$",h="["+t(n.delimiter||"/#?")+"]",g=u?"^":"",_=0,m=e;_<m.length;_++){var S=m[_];if("string"==typeof S)g+=t(f(S));else{var v=t(f(S.prefix)),I=t(f(S.suffix));if(S.pattern)if(i&&i.push(S),v||I)if("+"===S.modifier||"*"===S.modifier){var R="*"===S.modifier?"?":"";g+="(?:"+v+"((?:"+S.pattern+")(?:"+I+v+"(?:"+S.pattern+"))*)"+I+")"+R}else g+="(?:"+v+"("+S.pattern+")"+I+")"+S.modifier;else g+="("+S.pattern+")"+S.modifier;else g+="(?:"+v+I+")"+S.modifier}}if(p)o||(g+=h+"?"),g+=n.endsWith?"(?="+d+")":"$";else{var T=e[e.length-1],y="string"==typeof T?h.indexOf(T[T.length-1])>-1:void 0===T;o||(g+="(?:"+h+"(?="+d+"))?"),y||(g+="(?="+h+"|"+d+")")}return new RegExp(g,r(n))}(e(i,a),n,a)}function n(e,t,a){return e instanceof RegExp?function(e,t){if(!t)return e;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,i=0,n=r.exec(e.source);n;)t.push({name:n[1]||i++,prefix:"",suffix:"",modifier:"",pattern:""}),n=r.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,i){var a=e.map((function(e){return n(e,t,i).source}));return new RegExp("(?:"+a.join("|")+")",r(i))}(e,t,a):i(e,t,a)}class a extends BITSMIST.v1.Organizer{static init(e,t){Object.defineProperty(e,"routeInfo",{get(){return this._routeInfo}}),Object.defineProperty(e,"specs",{get(){return this._specs}}),Object.defineProperty(e,"spec",{get(){return this._spec}}),e.loadParameters=function(e){return a._loadParameters(e)},e.switchSpec=function(e,t){return a._switchSpec(this,e,t)},e.openRoute=function(e,t){return a._open(this,e,t)},e.jumpRoute=function(e,t){return a._jumpRoute(this,e,t)},e.updateRoute=function(e,t){return a._updateRoute(this,e,t)},e.refreshRoute=function(e,t){return a._refreshRoute(this,e,t)},e.replaceRoute=function(e,t){return a._replaceRoute(this,e,t)},e.validateRoute=function(){return a._validateRoute(this)},e.normalizeRoute=function(){return a._normalizeRoute(this)},e._routes=[],e._specs={},e._spec=new BITSMIST.v1.ChainableStore({chain:e.settings,writeThrough:!0}),Object.defineProperty(e,"settings",{get(){return this._spec}}),a.__initPopState(e),history.replaceState(a.__getState("connect"),null,null)}static organize(e,t,r){a._loadAttrSettings(t);let i=r.routes;if(i)for(let e=0;e<i.length;e++)a._addRoute(t,i[e]);t._routeInfo=a.__loadRouteInfo(t,window.location.href);let n=t.settings.get("specs");n&&Object.keys(n).forEach((e=>{t._specs[e]=n[e]}))}static _addRoute(e,t,r){let i=[],a={origin:t.origin,name:t.name,path:t.path,keys:i,specName:t.specName,componentName:t.componentName,re:n(t.path,i)};r?e._routes.unshift(a):e._routes.push(a)}static _buildUrl(e,t,r){let i="";if(i+=t.url?t.url:"",i+=t.path?t.path:"",i+=t.query?"?"+t.query:"",t.queryParameters){let n={};r&&r.mergeParameters&&(n=Object.assign(n,e.routeInfo.queryParameters)),n=Object.assign(n,t.queryParameters),i+=a._buildUrlQuery(n)}return i||"/"}static _buildUrlQuery(e){let t="";return e&&(t=Object.keys(e).reduce(((t,r)=>(Array.isArray(e[r])?t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r].join())+"&":e[r]&&(t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r])+"&"),t)),"")),t?"?"+t.slice(0,-1):""}static _loadParameters(e){e=e||window.location.href;let t,r,i={};if(window.location.href.indexOf("?")>-1){let n=e.slice(e.indexOf("?")+1).split("&");for(let e=0;e<n.length;e++)t=n[e].split("="),r=t[1]?t[1].split("#")[0]:t[1],i[t[0]]=decodeURIComponent(r)}return i}static _switchSpec(e,t,r){return BITSMIST.v1.Util.assert(t,"RouteOrganizer._switchSpec(): A spec name not specified.",TypeError),Promise.resolve().then((()=>{if(!e._specs[t])return a._loadSpec(e,t,r).then((r=>{e._specs[t]=r}))})).then((()=>{e._spec.items=e._specs[t]})).then((()=>e.addOrganizers(e._specs[t]))).then((()=>{if(e.settings.get("settings.hasExtender"))return a._loadExtender(e,t,r)})).then((()=>e.callOrganizers("afterSpecLoad",e._specs[t]))).then((()=>e.trigger("afterSpecLoad",{spec:e._specs[e._routeInfo.specName]})))}static _open(e,t,r){r=Object.assign({},r);let i,n,o=BITSMIST.v1.Util.safeGet(r,"pushState",!!t),s=e._routeInfo;if(t?(i=a._buildUrl(e,t,r),n=a.__loadRouteInfo(e,i)):(i=window.location.href,n=s),!r.jump&&n.name&&s.specName==n.specName)return Promise.resolve().then((()=>{o&&history.pushState(a.__getState("_open.pushState"),null,i),e._routeInfo=n})).then((()=>{if(s.specName!=n.specName)return a._updateRoute(e,s,n,r)})).then((()=>a._validateRoute(e,i))).then((()=>a._refreshRoute(e,n,r))).then((()=>a._normalizeRoute(e,window.location.href)));a._jumpRoute(e,{url:i})}static _jumpRoute(e,t,r){let i=a._buildUrl(e,t,r);window.location.href=i}static _updateRoute(e,t,r,i){return Promise.resolve().then((()=>e.changeState("routing"))).then((()=>e.clearOrganizers("afterStart",e._specs[t.specName]))).then((()=>e.clearOrganizers("afterSpecLoad",e._specs[t.specName]))).then((()=>a._switchSpec(e,r.specName))).then((()=>e._postStart()))}static _refreshRoute(e,t,r){return e.refresh(r)}static _replaceRoute(e,t,r){history.replaceState(a.__getState("replaceRoute",window.history.state),null,a._buildUrl(e,t,r)),e._routeInfo=a.__loadRouteInfo(e,window.location.href)}static _validateRoute(e,t){return e.validationResult.result=!0,Promise.resolve().then((()=>e.trigger("beforeValidate"))).then((()=>e.callOrganizers("doCheckValidity",{item:a._loadParameters(t),validationName:e.settings.get("settings.validationName")}))).then((()=>{if(!e.validationResult.result&&e.settings.get("settings.autoFixURL"))return a.__fixRoute(e,t)})).then((()=>e.trigger("doValidate"))).then((()=>e.trigger("afterValidate"))).then((()=>{if(!e.validationResult.result)throw a.__dumpValidationErrors(e),new URIError("URL validation failed.")}))}static _normalizeRoute(e,t){return Promise.resolve().then((()=>e.trigger("beforeNormalizeURL"))).then((()=>e.trigger("doNormalizeURL"))).then((()=>e.trigger("afterNormalizeURL")))}static _loadAttrSettings(e){let t=e.getAttribute("bm-specpath");t&&e.settings.set("loadings.specPath",t)}static _loadSpec(e,t,r){let i,n=[],a=BITSMIST.v1.Util.safeGet(r,"path",BITSMIST.v1.Util.concatPath([e.settings.get("loadings.appBaseUrl",BITSMIST.v1.settings.get("system.appBaseUrl","")),e.settings.get("loadings.specPath",BITSMIST.v1.settings.get("system.specPath",""))])),o=BITSMIST.v1.Util.deepMerge({type:"js",bindTo:this},r);return n.push(e.loadSettingFile(t,a,o)),Promise.all(n).then((e=>(i=e[0],i)))}static _loadExtender(e,t,r){let i=BITSMIST.v1.Util.safeGet(r,"query"),n=BITSMIST.v1.Util.safeGet(r,"path",BITSMIST.v1.Util.concatPath([e.settings.get("loadings.appBaseUrl",BITSMIST.v1.settings.get("system.appBaseUrl","")),e.settings.get("loadings.specPath",BITSMIST.v1.settings.get("system.specPath",""))]))+t+".extender.js"+(i?"?"+i:"");return BITSMIST.v1.AjaxUtil.loadScript(n)}static __loadRouteInfo(e,t){let r,i,n={},o=new URL(t,window.location.href),s={};for(let t=e._routes.length-1;t>=0;t--){if(e._routes[t].origin&&o.origin!=e._routes[t].origin)continue;let n=e._routes[t].path?e._routes[t].re.exec(o.pathname):[];if(n){r=e._routes[t].name,i=e._routes[t].specName?e._routes[t].specName:"";for(let r=0;r<n.length-1;r++){s[e._routes[t].keys[r].name]=n[r+1];let a=e._routes[t].keys[r].name,o=n[r+1];i=i.replace("{{:"+a+"}}",o)}break}}return n.name=r,n.specName=i,n.url=o.href,n.path=o.pathname,n.query=o.search,n.parsedUrl=o,n.routeParameters=s,n.queryParameters=a._loadParameters(t),n}static __initPopState(e){window.addEventListener("popstate",(t=>Promise.resolve().then((()=>e.trigger("beforePopState"))).then((()=>a._open(e,{url:window.location.href},{pushState:!1}))).then((()=>e.trigger("afterPopState")))))}static __getState(e,t){let r={msg:e};return t&&(r=BITSMIST.v1.Util.deepMerge(BITSMIST.v1.Util.deepClone(t),r)),r}static __fixRoute(e,t){let r=!0,i=a._loadParameters(t);Object.keys(e.validationResult.invalids).forEach((t=>{let n=e.validationResult.invalids[t];void 0!==n.fix?i[n.key]=n.fix:"notAllowed"===n.failed[0].validity?delete i[n.key]:r=!1})),r&&(a._replaceRoute(e,{queryParameters:i}),e.validationResult.result=!0)}static __dumpValidationErrors(e){Object.keys(e.validationResult.invalids).forEach((t=>{let r=e.validationResult.invalids[t];if(r.failed)for(let e=0;e<r.failed.length;e++);}))}}function o(){return Reflect.construct(BITSMIST.v1.Component,[],this.constructor)}BITSMIST.v1.ClassUtil.inherit(o,BITSMIST.v1.Component),customElements.define("bm-router",o),o.prototype._getSettings=function(e){let t={settings:{name:"Router",autoFixURL:!1,autoFetch:!1,autoSetup:!1,autoRefresh:!1,hasTemplate:!1,rootElement:document.body},organizers:{RouteOrganizer:{settings:{attach:!0}},ValidationOrganizer:{settings:{attach:!0}}},events:{this:{handlers:{doStart:["onDoStart"],afterStart:["onAfterStart"]}}}};return e=e?BITSMIST.v1.Util.deepMerge(e,t):t},o.prototype.onDoStart=function(e,t,r){if(this.routeInfo.specName){let e={query:this.settings.get("loadings.query")};return this.switchSpec(this.routeInfo.specName,e)}},o.prototype.onAfterStart=function(e,t,r){return this.openRoute()},window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},BITSMIST.v1.OrganizerOrganizer.register("RouteOrganizer",{object:a,targetWords:"routes",targetEvents:["beforeStart","afterSpecLoad"],order:900}),window.BITSMIST.v1.Router=o}();
