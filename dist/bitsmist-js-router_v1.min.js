!function(){"use strict";function e(e,r){void 0===r&&(r={});for(var n=function(e){for(var t=[],r=0;r<e.length;){var n=e[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)t.push({type:"CHAR",index:r,value:e[r++]});else{var o=1,i="";if("?"===e[u=r+1])throw new TypeError('Pattern cannot start with "?" at '+u);for(;u<e.length;)if("\\"!==e[u]){if(")"===e[u]){if(0==--o){u++;break}}else if("("===e[u]&&(o++,"?"!==e[u+1]))throw new TypeError("Capturing groups are not allowed at "+u);i+=e[u++]}else i+=e[u++]+e[u++];if(o)throw new TypeError("Unbalanced pattern at "+r);if(!i)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:i}),r=u}else{for(var a="",u=r+1;u<e.length;){var s=e.charCodeAt(u);if(!(s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||95===s))break;a+=e[u++]}if(!a)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:a}),r=u}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),o=r.prefixes,i=void 0===o?"./":o,a="[^"+t(r.delimiter||"/#?")+"]+?",u=[],s=0,p=0,f="",c=function(e){if(p<n.length&&n[p].type===e)return n[p++].value},l=function(e){var t=c(e);if(void 0!==t)return t;var r=n[p],o=r.type,i=r.index;throw new TypeError("Unexpected "+o+" at "+i+", expected "+e)},d=function(){for(var e,t="";e=c("CHAR")||c("ESCAPED_CHAR");)t+=e;return t};p<n.length;){var _=c("CHAR"),h=c("NAME"),m=c("PATTERN");if(h||m){var v=_||"";-1===i.indexOf(v)&&(f+=v,v=""),f&&(u.push(f),f=""),u.push({name:h||s++,prefix:v,suffix:"",pattern:m||a,modifier:c("MODIFIER")||""})}else{var g=_||c("ESCAPED_CHAR");if(g)f+=g;else if(f&&(u.push(f),f=""),c("OPEN")){v=d();var S=c("NAME")||"",I=c("PATTERN")||"",y=d();l("CLOSE"),u.push({name:S||(I?s++:""),pattern:S&&!I?a:I,prefix:v,suffix:y,modifier:c("MODIFIER")||""})}else l("END")}}return u}function t(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function r(e){return e&&e.sensitive?"":"i"}function n(n,o,i){return function(e,n,o){void 0===o&&(o={});for(var i=o.strict,a=void 0!==i&&i,u=o.start,s=void 0===u||u,p=o.end,f=void 0===p||p,c=o.encode,l=void 0===c?function(e){return e}:c,d="["+t(o.endsWith||"")+"]|$",_="["+t(o.delimiter||"/#?")+"]",h=s?"^":"",m=0,v=e;m<v.length;m++){var g=v[m];if("string"==typeof g)h+=t(l(g));else{var S=t(l(g.prefix)),I=t(l(g.suffix));if(g.pattern)if(n&&n.push(g),S||I)if("+"===g.modifier||"*"===g.modifier){var y="*"===g.modifier?"?":"";h+="(?:"+S+"((?:"+g.pattern+")(?:"+I+S+"(?:"+g.pattern+"))*)"+I+")"+y}else h+="(?:"+S+"("+g.pattern+")"+I+")"+g.modifier;else h+="("+g.pattern+")"+g.modifier;else h+="(?:"+S+I+")"+g.modifier}}if(f)a||(h+=_+"?"),h+=o.endsWith?"(?="+d+")":"$";else{var w=e[e.length-1],R="string"==typeof w?_.indexOf(w[w.length-1])>-1:void 0===w;a||(h+="(?:"+_+"(?="+d+"))?"),R||(h+="(?="+_+"|"+d+")")}return new RegExp(h,r(o))}(e(n,i),o,i)}function o(e,t,i){return e instanceof RegExp?function(e,t){if(!t)return e;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,n=0,o=r.exec(e.source);o;)t.push({name:o[1]||n++,prefix:"",suffix:"",modifier:"",pattern:""}),o=r.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,n){var i=e.map((function(e){return o(e,t,n).source}));return new RegExp("(?:"+i.join("|")+")",r(n))}(e,t,i):n(e,t,i)}var i=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.init=function(e,r){Object.defineProperty(e,"routeInfo",{get:function(){return this._routeInfo}}),Object.defineProperty(e,"specs",{get:function(){return this._specs}}),e.loadParameters=function(){return t._loadParameters()},e.openRoute=function(e,r){return t._open(this,e,r)},e.replaceRoute=function(e,r){return t._replace(this,e,r)},e.jumpRoute=function(e,r){return t._jump(this,e,r)},e.refreshRoute=function(e,r){return t._refresh(this,e,r)},e.updateRoute=function(e,r){return t._update(this,e,r)},e._routes=[],e._specs={},t.__initPopState(e),history.replaceState(t.__getState("connect"),null,null)},t.organize=function(e,r,n){t.__loadAttrSettings(r);var o=r.settings.get("routes");if(o){for(var i=0;i<o.length;i++)t._addRoute(r,o[i]);r._routeInfo=t.__loadRouteInfo(r,window.location.href)}var a=r.settings.get("specs");a&&Object.keys(a).forEach((function(e){r._specs[e]=a[e]}))},t._addRoute=function(e,t,r){var n=[],i={origin:t.origin,name:t.name,path:t.path,keys:n,specName:t.specName,componentName:t.componentName,re:o(t.path,n)};r?e._routes.unshift(i):e._routes.push(i)},t._buildUrl=function(e,r){var n;return e.url?n=e.url:(n=e.path?e.path:r._routeInfo.path,n+=e.query?"?"+e.query:"",n+=e.queryParameters?t._buildUrlQuery(e.queryParameters):""),n},t._buildUrlQuery=function(e){var t="";return e&&(t=Object.keys(e).reduce((function(t,r){return Array.isArray(e[r])?t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r].join())+"&":e[r]&&(t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r])+"&"),t}),"")),t?"?"+t.slice(0,-1):""},t._loadParameters=function(){var e,t,r={};if(window.location.href.indexOf("?")>-1)for(var n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<n.length;o++)t=(e=n[o].split("="))[1]?e[1].split("#")[0]:e[1],r[e[0]]=decodeURIComponent(t);return r},t._open=function(e,r,n){(n=Object.assign({},n)).pushState=void 0===n.pushState||n.pushState;var o=t._buildUrl(r,e),i=Object.assign({},e._routeInfo),a=t.__loadRouteInfo(e,o);if(e._routeInfo=a,!n.jump&&a.name&&i.name==a.name)return Promise.resolve().then((function(){n.pushState&&history.pushState(t.__getState("_open.pushState"),null,o)})).then((function(){return i.specName!=a.specName?t._update(e,a,n):t._refresh(e,r,n)})).then((function(){r.dispUrl&&history.replaceState(t.__getState("_open.dispUrl",window.history.state),null,r.dispUrl)}));t._jump(e,{url:o})},t._jump=function(e,r){var n=t._buildUrl(r,e);window.location.href=n},t._refresh=function(e,t,r){var n=e._routeInfo.componentName;if(e._components&&e._components[n])return e._components[n].refresh({sender:e,pushState:!1})},t._update=function(e,r,n){return Promise.resolve().then((function(){return e.clearOrganizers()})).then((function(){return t.__initSpec(e,r.specName)}))},t._replace=function(e,r,n){history.replaceState(t.__getState("replaceRoute",window.history.state),null,t._buildUrl(r,e)),e._routeInfo=t.__loadRouteInfo(e,window.location.href)},t.__initSpec=function(e,r){if(r&&!e._specs[r])return Promise.resolve().then((function(){if(!e._specs[r])return t.__loadSpec(e,r,e.settings.get("system.specPath")).then((function(t){e._specs[r]=t}))})).then((function(){return e.addOrganizers(e._specs[r])})).then((function(){return e.callOrganizers("afterSpecLoad",e._specs[r])})).then((function(){return e.trigger("afterSpecLoad",e,{spec:e._specs[e._routeInfo.specName]})}))},t.__loadSpec=function(e,t,r){var n=[];return n.push(BITSMIST.v1.SettingOrganizer.loadSetting(t,r,"js")),Promise.all(n).then((function(e){return e[0]}))},t.__loadRouteInfo=function(e,r){for(var n,o,i,a={},u=new URL(r,window.location.href),s={},p=e._routes.length-1;p>=0;p--)if(!e._routes[p].origin||e._routes[p].origin&&u.origin==e._routes[p].origin){var f=e._routes[p].path?e._routes[p].re.exec(u.pathname):[];if(f){n=e._routes[p].name,o=e._routes[p].specName?e._routes[p].specName:"",i=e._routes[p].componentName;for(var c=0;c<f.length-1;c++){s[e._routes[p].keys[c].name]=f[c+1];var l=e._routes[p].keys[c].name,d=f[c+1];o=o.replace("{{:"+l+"}}",d)}break}}return a.name=n,a.specName=o,a.componentName=i,a.url=u.href,a.path=u.pathname,a.query=u.search,a.parsedUrl=u,a.routeParameters=s,a.queryParameters=t._loadParameters(),a},t.__initPopState=function(e){window.addEventListener("popstate",(function(r){var n=e._routeInfo.componentName,o=e._components&&e._components[n];return Promise.resolve().then((function(){if(o)return o.trigger("beforePopState",e)})).then((function(){return t._open(e,t.__loadRouteInfo(e,window.location.href),{pushState:!1})})).then((function(){if(o)return o.trigger("afterPopState",e)}))}))},t.__getState=function(e,t){var r={msg:e};return t&&(r=Object.assign({},t,r)),r},t.__loadAttrSettings=function(e){var t=e.getAttribute("bm-specpath");t&&e._settings.set("system.specPath",t)},t}(BITSMIST.v1.Organizer);function a(){return Reflect.construct(BITSMIST.v1.Component,[],this.constructor)}BITSMIST.v1.ClassUtil.inherit(a,BITSMIST.v1.Component),customElements.define("bm-router",a),a.prototype.start=function(e){var t=this,r={settings:{name:"Router",autoSetup:!1,autoPostStart:!1,rootElement:document.body},organizers:{RouteOrganizer:{settings:{attach:!0}}}};return e=e?BITSMIST.v1.Util.deepMerge(r,e):r,Promise.resolve().then((function(){return BITSMIST.v1.Component.prototype.start.call(t,e)})).then((function(){return i.__initSpec(t,t._routeInfo.specName).then((function(){t._postStart()}))}))},window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},BITSMIST.v1.OrganizerOrganizer.organizers.set("RouteOrganizer",{object:i,targetWords:"routes",targetEvents:["beforeStart","afterSpecLoad"],order:4100}),window.BITSMIST.v1.Router=a}();
