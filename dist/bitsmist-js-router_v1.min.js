!function(){"use strict";function r(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],n=0;n<e.length;){var r=e[n];if("*"!==r&&"+"!==r&&"?"!==r)if("\\"!==r)if("{"!==r)if("}"!==r)if(":"!==r)if("("!==r)t.push({type:"CHAR",index:n,value:e[n++]});else{var o=1,i="";if("?"===e[u=n+1])throw new TypeError('Pattern cannot start with "?" at '+u);for(;u<e.length;)if("\\"!==e[u]){if(")"===e[u]){if(0===--o){u++;break}}else if("("===e[u]&&(o++,"?"!==e[u+1]))throw new TypeError("Capturing groups are not allowed at "+u);i+=e[u++]}else i+=e[u++]+e[u++];if(o)throw new TypeError("Unbalanced pattern at "+n);if(!i)throw new TypeError("Missing pattern at "+n);t.push({type:"PATTERN",index:n,value:i}),n=u}else{for(var a="",u=n+1;u<e.length;){var s=e.charCodeAt(u);if(!(48<=s&&s<=57||65<=s&&s<=90||97<=s&&s<=122||95===s))break;a+=e[u++]}if(!a)throw new TypeError("Missing parameter name at "+n);t.push({type:"NAME",index:n,value:a}),n=u}else t.push({type:"CLOSE",index:n,value:e[n++]});else t.push({type:"OPEN",index:n,value:e[n++]});else t.push({type:"ESCAPED_CHAR",index:n++,value:e[n++]});else t.push({type:"MODIFIER",index:n,value:e[n++]})}return t.push({type:"END",index:n,value:""}),t}(e),e=t.prefixes,n=void 0===e?"./":e,o="[^"+m(t.delimiter||"/#?")+"]+?",i=[],a=0,u=0,s="",p=function(e){if(u<r.length&&r[u].type===e)return r[u++].value},c=function(e){var t=p(e);if(void 0!==t)return t;var n=r[u],t=n.type,n=n.index;throw new TypeError("Unexpected "+t+" at "+n+", expected "+e)},f=function(){for(var e,t="";e=p("CHAR")||p("ESCAPED_CHAR");)t+=e;return t};u<r.length;){var l,d=p("CHAR"),_=p("NAME"),h=p("PATTERN");_||h?(l=d||"",-1===n.indexOf(l)&&(s+=l,l=""),s&&(i.push(s),s=""),i.push({name:_||a++,prefix:l,suffix:"",pattern:h||o,modifier:p("MODIFIER")||""})):(_=d||p("ESCAPED_CHAR"))?s+=_:(s&&(i.push(s),s=""),p("OPEN")?(l=f(),h=p("NAME")||"",d=p("PATTERN")||"",_=f(),c("CLOSE"),i.push({name:h||(d?a++:""),pattern:h&&!d?o:d,prefix:l,suffix:_,modifier:p("MODIFIER")||""})):c("END"))}return i}function m(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function g(e){return e&&e.sensitive?"":"i"}function a(e,t,n){return function(e,t,n){void 0===n&&(n={});for(var r=n.strict,o=void 0!==r&&r,i=n.start,a=void 0===i||i,u=n.end,r=void 0===u||u,i=n.encode,s=void 0===i?function(e){return e}:i,u="["+m(n.endsWith||"")+"]|$",i="["+m(n.delimiter||"/#?")+"]",p=a?"^":"",c=0,f=e;c<f.length;c++){var l,d,_,h=f[c];"string"==typeof h?p+=m(s(h)):(l=m(s(h.prefix)),d=m(s(h.suffix)),h.pattern?(t&&t.push(h),l||d?"+"===h.modifier||"*"===h.modifier?(_="*"===h.modifier?"?":"",p+="(?:"+l+"((?:"+h.pattern+")(?:"+d+l+"(?:"+h.pattern+"))*)"+d+")"+_):p+="(?:"+l+"("+h.pattern+")"+d+")"+h.modifier:p+="("+h.pattern+")"+h.modifier):p+="(?:"+l+d+")"+h.modifier)}r?(o||(p+=i+"?"),p+=n.endsWith?"(?="+u+")":"$"):(e=e[e.length-1],e="string"==typeof e?-1<i.indexOf(e[e.length-1]):void 0===e,o||(p+="(?:"+i+"(?="+u+"))?"),e||(p+="(?="+i+"|"+u+")"));return new RegExp(p,g(n))}(r(e,n),t,n)}function u(e,t,n){return e instanceof RegExp?function(e,t){if(!t)return e;for(var n=/\((?:\?<(.*?)>)?(?!\?)/g,r=0,o=n.exec(e.source);o;)t.push({name:o[1]||r++,prefix:"",suffix:"",modifier:"",pattern:""}),o=n.exec(e.source);return e}(e,t):Array.isArray(e)?(o=t,i=n,r=(r=e).map(function(e){return u(e,o,i).source}),new RegExp("(?:"+r.join("|")+")",g(i))):a(e,t,n);var r,o,i}var n=function(e){function d(){e.apply(this,arguments)}return e&&(d.__proto__=e),((d.prototype=Object.create(e&&e.prototype)).constructor=d).globalInit=function(){d.__skipPopstate=!1;var e=window.navigator.userAgent.toLowerCase();-1<e.indexOf("safari")&&-1==e.indexOf("chrome")&&window.addEventListener("DOMContentLoaded",function(e){d.__skipPopstate=!0})},d.init=function(e,t,n){Object.defineProperty(t,"routeInfo",{get:function(){return this._routeInfo}}),Object.defineProperty(t,"specs",{get:function(){return this._specs}}),t.loadParameters=function(){return d._loadParameters()},t.openRoute=function(e,t){return d._open(this,e,t)},t.replaceRoute=function(e,t){return d._replace(this,e,t)},t.jumpRoute=function(e,t){return d._jump(this,e,t)},t.refreshRoute=function(e,t){return d._refresh(this,e,t)},t.updateRoute=function(e,t){return d._update(this,e,t)},t._routes=[],t._specs={},d.__initPopState(t),history.replaceState(d.__getState("connect"),null,null)},d.organize=function(e,t,n){var r=t.settings.get("routes");if(r){for(var o=0;o<r.length;o++)d._addRoute(t,r[o]);t._routeInfo=d.__loadRouteInfo(t,window.location.href)}var i=t.settings.get("specs");return i&&Object.keys(i).forEach(function(e){t._specs[e]=i[e]}),n},d._addRoute=function(e,t,n){var r=[],r={origin:t.origin,name:t.name,path:t.path,keys:r,specName:t.specName,componentName:t.componentName,re:u(t.path,r)};n?e._routes.unshift(r):e._routes.push(r)},d._buildUrl=function(e,t){var n;return e.url?n=e.url:(n=e.path||t._routeInfo.path,n+=e.query?"?"+e.query:"",n+=e.queryParameters?d._buildUrlQuery(e.queryParameters):""),n},d._buildUrlQuery=function(n){var e="";return(e=n?Object.keys(n).reduce(function(e,t){return Array.isArray(n[t])?e+=encodeURIComponent(t)+"="+encodeURIComponent(n[t].join())+"&":n[t]&&(e+=encodeURIComponent(t)+"="+encodeURIComponent(n[t])+"&"),e},""):e)?"?"+e.slice(0,-1):""},d._loadParameters=function(){var e,t,n={};if(-1<window.location.href.indexOf("?"))for(var r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),o=0;o<r.length;o++)t=(e=r[o].split("="))[1]&&e[1].split("#")[0],n[e[0]]=decodeURIComponent(t);return n},d._open=function(e,t,n){(n=Object.assign({},n)).pushState=void 0===n.pushState||n.pushState;var r=d._buildUrl(t,e),o=Object.assign({},e._routeInfo),i=d.__loadRouteInfo(e,r);if(e._routeInfo=i,!n.jump&&i.name&&o.name==i.name)return Promise.resolve().then(function(){n.pushState&&history.pushState(d.__getState("_open.pushState"),null,r)}).then(function(){return o.specName!=i.specName?d._update(e,i,n):d._refresh(e,t,n)}).then(function(){t.dispUrl&&history.replaceState(d.__getState("_open.dispUrl",window.history.state),null,t.dispUrl)});d._jump(e,{url:r})},d._jump=function(e,t){e=d._buildUrl(t,e);window.location.href=e},d._refresh=function(e,t,n){var r=e._routeInfo.componentName;if(e._components&&e._components[r])return e._components[r].refresh({sender:e,pushState:!1})},d._update=function(e,t,n){return Promise.resolve().then(function(){return e.clearOrganizers()}).then(function(){return d.__initSpec(e,t.specName)})},d._replace=function(e,t,n){history.replaceState(d.__getState("replaceRoute",window.history.state),null,d._buildUrl(t,e)),e._routeInfo=d.__loadRouteInfo(e,window.location.href)},d.__initSpec=function(t,n){if(n&&!t._specs[n])return Promise.resolve().then(function(){if(!t._specs[n])return d.__loadSpec(n,t.settings.get("system.specPath")).then(function(e){t._specs[n]=e})}).then(function(){return t.callOrganizers("afterSpecLoad",t._specs[n])}).then(function(){return t.trigger("afterSpecLoad",t,{spec:t._specs[t._routeInfo.specName]})})},d.__loadSpec=function(e,t){var n,r=BITSMIST.v1.Util.concatPath([t,e+".js"]),e=[];return e.push(BITSMIST.v1.AjaxUtil.ajaxRequest({url:r,method:"GET"})),Promise.all(e).then(function(e){try{n=JSON.parse(e[0].responseText)}catch(e){throw e instanceof SyntaxError?new SyntaxError("Illegal json string. url="+r+", message="+e.message):e}return n})},d.__loadRouteInfo=function(e,t){for(var n,r={},o=new URL(t,window.location.href),i={},a=e._routes.length-1;0<=a;a--)if(!e._routes[a].origin||e._routes[a].origin&&o.origin==e._routes[a].origin){var u=e._routes[a].path?e._routes[a].re.exec(o.pathname):[];if(u){n=e._routes[a].name,l=e._routes[a].specName||"";for(var s=e._routes[a].componentName,p=0;p<u.length-1;p++){i[e._routes[a].keys[p].name]=u[p+1];var c=e._routes[a].keys[p].name,f=u[p+1],l=l.replace("{{:"+c+"}}",f)}break}}return r.name=n,r.specName=l,r.componentName=s,r.url=o.href,r.path=o.pathname,r.query=o.search,r.parsedUrl=o,r.routeParameters=i,r.queryParameters=d._loadParameters(),r},d.__initPopState=function(r){window.history&&window.history.pushState&&window.addEventListener("popstate",function(e){if(!d.__skipPopstate){var t,n=r._routeInfo.componentName;return r._components&&r._components[n]&&(t=r._components[n].trigger("beforePopState",r)),Promise.all([t]).then(function(){return d._open(r,d.__loadRouteInfo(r,window.location.href),{pushState:!1})}).then(function(){var e=r._routeInfo.componentName;if(r._components&&r._components[e])return r._components[e].trigger("afterPopState",r)})}d.__skipPopstate=!1})},d.__getState=function(e,t){e={msg:e};return e=t?Object.assign({},t,e):e},d}(BITSMIST.v1.Organizer);function e(){return Reflect.construct(BITSMIST.v1.Component,[],this.constructor)}BITSMIST.v1.ClassUtil.inherit(e,BITSMIST.v1.Component),customElements.define("bm-router",e),e.prototype.start=function(e){var t=this;return e=BITSMIST.v1.Util.deepMerge({name:"Router",autoSetup:!1,organizers:{RouteOrganizer:""}},e),BITSMIST.v1.Component.prototype.start.call(this,e).then(function(){t.changeState("routing");var e=t.getAttribute("data-specpath")||"";return e&&t._settings.set("system.specPath",e),n.__initSpec(t,t._routeInfo.specName).then(function(){t.changeState("routed")})})},window.BITSMIST=window.BITSMIST||{},window.BITSMIST.v1=window.BITSMIST.v1||{},BITSMIST.v1.OrganizerOrganizer.organizers.set("RouteOrganizer",{object:n,targetWords:"routes",targetEvents:["beforeStart","afterSpecLoad"],order:300}),window.BITSMIST.v1.Router=e}();
